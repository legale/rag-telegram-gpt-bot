## Раздел 1. Краткий обзор проблем
Повторный анализ показал, что основная сложность по‑прежнему сосредоточена в RetrievalService и вспомогательных поисковых функциях: `_two_stage_search`, `_retrieve_chunks_from_topics` и `search_message_contents` выполняют по несколько несвязанных задач, дублируют преобразования distance↔similarity и снова парсят одни и те же метаданные. Telegram-обвязка (`src/bot/tgbot.py`) выросла до монолита: `handle_message`, `handle_user_query` и `init_runtime_for_current_profile` занимаются всем сразу (от проверки доступа до регистрации каждого маршрута), а глобальные переменные вроде `chat_counters` определяются дважды. Ingestion-пайплайн на стадии `run_stage3` содержит громоздкий код подготовки метаданных и проверок размерностей, который сложно поддерживать. CLI-вход (`src/bot/cli.py`) копирует большую часть логики `MessageHandler`, из-за чего любое изменение команд нужно повторять вручную. В репозитории всё ещё лежит легаси-модуль `src/core/topics.py` (SimpleKMeans/TopicSummarizer) и тесты к нему, не участвующие в рабочем процессе.

## Раздел 2. Плоский список задач рефакторинга
- [ ] file=src/core/retrieval.py func=_two_stage_search уменьшить цикломатическую сложность: выделить отдельные приватные функции для запроса L2‑тем, фильтрации чанков в chroma и sqlite‑фолбэка, чтобы основной метод только связывал эти шаги.
- [ ] files=src/core/retrieval.py funcs=_retrieve_chunks_from_topics,_get_chunks_by_ids убрать дублирование парсинга `metadata_json` и наполнения `topic_*`: создать единый helper построения метаданных и использовать его в обоих местах.
- [ ] file=src/core/message_search.py func=search_message_contents упростить логику, разбив на функции «получить результаты», «отфильтровать по threshold», «преобразовать в message parts», чтобы снизить вложенность и повторение кода.
- [ ] files=src/core/message_search.py funcs=search_message_links,search_message_contents вынести общее преобразование результатов retrieval (id/distance/metadata) и логирование расстояний в отдельный helper, чтобы исключить дублирование и расхождения поведений.
- [ ] file=src/bot/tgbot.py func=handle_message сократить ветвления, вынеся обработку публичных команд, проверку access_control, определение поисковых упоминаний и обычных запросов в отдельные функции, чтобы центральный обработчик только маршрутизировал update.
- [ ] file=src/bot/tgbot.py class=MessageHandler func=handle_user_query выделить отдельный метод для debug‑вывода (печать чанков и промпта) и подготовки system prompt, чтобы основной метод отвечал лишь за вызов `chat()`.
- [ ] file=src/bot/tgbot.py func=init_runtime_for_current_profile упростить регистрацию команд: добавить helper, который принимает роутер и набор командных классов, и убрать цепочки однотипных `register(...)`, снижая дублирование.
- [ ] file=src/bot/tgbot.py удалить дублирующее объявление `chat_counters` и сопутствующие комментированные блоки (строки 63/745), оставив единственный источник данных для счётчиков.
- [ ] files=src/bot/cli.py funcs=handle_cli_command,handle_find_command_cli,parse_find_command_args уменьшить дублирование с `MessageHandler`, переиспользовав общий парсер команд и обработчик `/find`, чтобы изменения командной логики в одном месте не требовали ручного копирования.
- [ ] file=src/ingestion/pipeline.py func=run_stage3 снизить сложность: вынести подготовку списков `ids/documents/metadatas`, проверку размерности коллекции и логирование в отдельные методы, а в `run_stage3` оставить только оркестрацию и обработку ошибок.
- [ ] file=src/bot/admin_tasks.py class=IngestionTask func=run разбить процесс на асинхронные шаги (парсинг файла, чанкинг, запись в SQL, запись в vector store, обновление прогресса), чтобы избавиться от гигантского метода и облегчить переиспользование прогресс‑логики.
- [ ] file=src/core/topics.py удалить неиспользуемые классы SimpleKMeans и TopicSummarizer (и tests/test_topics.py) либо интегрировать оставшуюся функциональность в `src/ai/clustering.py`, чтобы убрать легаси‑код, который не участвует в пайплайне.
