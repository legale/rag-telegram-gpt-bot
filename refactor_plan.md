## Раздел 1. Краткий обзор проблем
Самые тяжёлые участки сосредоточены в RetrievalService (`src/core/retrieval.py`) и message_search (`src/core/message_search.py`): монолитные функции совмещают работу с БД, векторным хранилищем, выбор режимов и логирование, из-за чего сложность и дублирование дистанционных расчётов растут лавинообразно. Telegram-обвязка (`src/bot/tgbot.py`) содержит огромные `handle_message`, `route_command` и `handle_find_command`, которые одновременно разбирают команды, проверяют доступ, управляют частотой и отсылают ответы, что делает поведение трудно прослеживаемым. Блоки админ-команд и фоновых задач повторяют одни и те же валидации профилей и шаблоны ответов, увеличивая размер классов. В кодовой базе остался легаси-модуль `src/core/topics.py` (SimpleKMeans/TopicSummarizer), который нигде не используется, но продолжает обрастать тестами. Наконец, обновление метаданных топиков и чанков разбросано по нескольким циклам в `src/ai/clustering.py`, что ведёт к сложным вложенным конструкциям без единых вспомогательных функций.

## Раздел 2. Плоский список задач рефакторинга
- [ ] file=src/core/retrieval.py func=retrieve снизить цикломатическую сложность: вынести вычисление эмбеддинга, выбор режима (two_stage/direct) и объединение результатов в отдельные приватные функции, чтобы основная функция была простым последовательным пайплайном.
- [ ] files=src/core/retrieval.py+src/core/message_search.py funcs=_process_chunk_results,search_chunks_basic,search_message_contents убрать дублирование преобразования distance↔similarity и сборки словаря чанка (метаданные, topics) — создать единый helper и переиспользовать его в перечисленных местах.
- [ ] file=src/core/message_search.py func=search_message_contents упростить логику: разделить на отдельные функции для поиска чанков, пороговой фильтрации и подготовки message parts, чтобы убрать вложенные циклы и повторные блоки логирования.
- [ ] file=src/bot/tgbot.py func=handle_message уменьшить объём и вложенность, выделив обработку публичных команд, проверку доступа, распознавание поисковых упоминаний и отправку результатов в отдельные функции, которые будет вызывать центральный роутер.
- [ ] file=src/bot/tgbot.py class=MessageHandler func=route_command заменить длинную цепочку if/elif на таблицу диспетчеризации (dict команд → методы), чтобы сократить ветвления и упростить добавление новых команд.
- [ ] file=src/bot/tgbot.py class=MessageHandler func=handle_find_command разбить на две функции: парсинг аргументов/threshold и отправку найденных сообщений, чтобы переиспользовать парсер и убрать повтор логики поиска из других мест (например, упоминания в handle_message).
- [ ] file=src/bot/admin_commands.py class=ProfileCommands убрать дублирование в list/create/info: добавить приватные хелперы для получения статистики профиля и форматирования ответа, чтобы каждая команда не повторяла чтение размеров БД и шаблоны Markdown.
- [ ] file=src/bot/admin_tasks.py class=IngestionTask func=run разложить на отдельные корутины (parse_file, chunk_messages, persist_sql, persist_vectors, update_progress) и вызывать их последовательной цепочкой, чтобы снизить объём метода и облегчить повторное использование прогресс-индикаторов.
- [ ] file=src/ai/clustering.py class=TopicClusterer funcs=perform_l1_clustering,perform_l2_clustering выделить общее обновление метаданных (обновление topic_l1_parent, update_chunk_metadata, прогресс-бар) в вспомогательные методы и заменить повторяющиеся try/except-блоки единым сервисом, чтобы упростить циклы и уменьшить дублирование.
- [ ] file=src/core/topics.py удалить неиспользуемые классы SimpleKMeans/TopicSummarizer (и сопутствующие тесты), либо перенести оставшуюся функциональность в `src/ai/clustering.py`, чтобы избавиться от легаси-кода, который не подключён к рабочему пайплайну.
