# Настройка кластеризации тем

## Проблема: слишком мало тем L1

Если после выполнения `legale topics build` вы видите слишком мало тем L1, это может быть связано с параметрами кластеризации HDBSCAN.

## Решения

### 1. Уменьшить `min_cluster_size`

**Проблема**: Минимальный размер кластера слишком большой, маленькие кластеры не создаются.

**Решение**: Уменьшите `--l1-min-size` до 2 (минимальное значение для HDBSCAN):

```bash
legale topics build --l1-min-size 2
```

**Рекомендации**:
- `2` - минимальное значение (HDBSCAN требует >= 2), создаст максимальное количество тем (по умолчанию)
- `3` - баланс между количеством тем и качеством
- `4+` - меньше тем, но более стабильные кластеры

**Важно**: HDBSCAN не поддерживает `min_cluster_size=1`, минимальное значение - 2.

### 2. Изменить метод выбора кластеров ⚠️ ВАЖНО!

**Проблема**: Метод `eom` (Excess of Mass) слишком консервативен и создает ОЧЕНЬ мало кластеров.

**Решение**: Используйте метод `leaf`, который создает НАМНОГО больше кластеров:

```bash
legale topics build --l1-method leaf
```

**Разница**:
- `eom` (по умолчанию) - создает **ОЧЕНЬ МАЛО** кластеров (5-15 для 1000+ чанков)
- `leaf` - создает **НАМНОГО БОЛЬШЕ** кластеров (50-200+ для 1000+ чанков)

**Рекомендация**: Если у вас мало тем, **ОБЯЗАТЕЛЬНО** используйте `--l1-method leaf`!

### 3. Изменить метрику расстояния

**Проблема**: Метрика `cosine` может не подходить для ваших данных.

**Решение**: Попробуйте `euclidean`:

```bash
legale topics build --l1-metric euclidean
```

**Разница**:
- `cosine` (по умолчанию) - лучше для семантических эмбеддингов
- `euclidean` - может найти больше кластеров в некоторых случаях
- `manhattan` - альтернатива для некоторых типов данных

### 4. Комбинированный подход

Для максимального количества тем попробуйте:

```bash
legale topics build \
  --l1-min-size 2 \
  --l1-method leaf \
  --l1-metric euclidean
```

### 5. Настройка epsilon

Параметр `--l1-epsilon` контролирует порог расстояния для объединения кластеров:

```bash
# Более агрессивное объединение (меньше тем)
legale topics build --l1-epsilon 0.1

# Меньше объединения (больше тем)
legale topics build --l1-epsilon 0.0  # по умолчанию
```

## Диагностика

После выполнения команды проверьте логи. Если вы видите:

```
high noise percentage, consider lowering min_cluster_size or min_samples
```

Это означает, что слишком много чанков помечены как шум (не попали ни в один кластер). В этом случае:

1. Убедитесь, что `--l1-min-size` равен 2 (минимальное значение)
2. Уменьшите `--l1-min-samples` (уже минимальное значение 1)
3. Попробуйте метод `leaf` вместо `eom`
4. Попробуйте метрику `euclidean` вместо `cosine`

## Примеры команд

### Консервативный подход (меньше тем, но стабильнее)
```bash
legale topics build --l1-min-size 3 --l1-method eom
```

### Агрессивный подход (больше тем)
```bash
legale topics build --l1-min-size 2 --l1-method leaf --l1-metric euclidean
```

### Сбалансированный подход (рекомендуется для большего количества тем)
```bash
legale topics build --l1-min-size 2 --l1-method leaf
```

### Максимальное количество тем (если все еще мало)
```bash
legale topics build --l1-min-size 2 --l1-method leaf --l1-metric euclidean
```

## Все доступные параметры

### L1 (мелкозернистые темы)
- `--l1-min-size` (2-10): Минимальный размер кластера (по умолчанию: 2, минимум: 2)
- `--l1-min-samples` (1-5): Минимум образцов в окрестности (по умолчанию: 1)
- `--l1-metric` (cosine/euclidean/manhattan): Метрика расстояния (по умолчанию: cosine)
- `--l1-method` (eom/leaf): Метод выбора кластеров (по умолчанию: eom)
- `--l1-epsilon` (0.0-1.0): Порог объединения кластеров (по умолчанию: 0.0)

### L2 (супер-темы)
- `--l2-min-size` (2-10): Минимальный размер кластера L2 (по умолчанию: 2)
- `--l2-min-samples` (1-5): Минимум образцов для L2 (по умолчанию: 1)
- `--l2-metric` (cosine/euclidean/manhattan): Метрика для L2 (по умолчанию: cosine)
- `--l2-method` (eom/leaf): Метод для L2 (по умолчанию: eom)
- `--l2-epsilon` (0.0-1.0): Порог для L2 (по умолчанию: 0.0)

## Проверка результатов

После построения тем проверьте количество:

```bash
legale topics list
```

Если тем все еще мало, попробуйте более агрессивные параметры из раздела "Агрессивный подход" выше.

